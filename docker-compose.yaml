services:
  nextjs:
    container_name: redis_nextjs_project
    build:
      context: .
      dockerfile: ./docker/dev/Dockerfile
      args:
        PROJECT: ${PROJECT:-}
    environment:
      - REDIS_URL=redis://redis:6379
    depends_on:
      - db
      - redis
    volumes:
      - .:/app
    ports:
      - "3000:3000"
      - "3001:3001"
    networks:
      - app-network

  db:
    image: postgres:16
    restart: always
    shm_size: 128mb
    ports:
      - 5433:5432
    environment:
      POSTGRES_DB: redis_nextjs_db
      POSTGRES_PASSWORD: password
    volumes:
      - ./sql/:/docker-entrypoint-initdb.d/
      - redis-postgres-db-data:/var/lib/postgresql/data/

  redis:
      image: redis:7-alpine
      ports:
        - "6379:6379" # Optionnel pour acc√®s local
      volumes:
        - redis-data:/data
      healthcheck:
        test: [ "CMD", "redis-cli", "ping" ]
        interval: 10s
        timeout: 5s
        retries: 5
      command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
      networks:
        - app-network
      restart: unless-stopped

volumes:
  redis-postgres-db-data: # data dir volume
  redis-data:

networks:
  app-network:
    driver: bridge